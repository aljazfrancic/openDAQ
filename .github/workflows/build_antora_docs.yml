name: Build openDAQ SDK documentation
on: workflow_dispatch

env:
  site_path: ${{ github.workspace }}/build/site/
  site_zip:  ${{ github.workspace }}/build/user_guide.zip

jobs:
  build_documentation:
    runs-on: ubuntu-22.04
    timeout-minutes: 7

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ───────────────────────────────────────────────────────────────
      # 1) Install Antora + global extensions in repo’s node_modules
      # ───────────────────────────────────────────────────────────────
      - name: Install Antora and global JS deps
        run: |
          npm install antora vinyl
          npm install @asciidoctor/tabs @springio/antora-extensions

      # ───────────────────────────────────────────────────────────────
      # 2) Clone ASAM extension and install its own dependencies
      # ───────────────────────────────────────────────────────────────
      - name: Clone ASAM Antora extension
        run: git clone https://code.asam.net/common/asam-antora-extensions.git asam-antora-extensions

      - name: Install ASAM extension dependencies
        working-directory: asam-antora-extensions
        run: |
          # If the extension has a package.json, use it; otherwise install needed libs directly
          if [ -f package.json ]; then
            npm install
          else
            npm install jsdom xml2js cheerio xregexp
          fi

      # ───────────────────────────────────────────────────────────────
      # 3) Duplicate the ASAM deps into Antora’s hard-coded search path
      #    (/usr/src/app/node_modules) so user-require can resolve them
      # ───────────────────────────────────────────────────────────────
      - name: Copy extension deps to /usr/src/app/node_modules
        run: |
          sudo mkdir -p /usr/src/app/node_modules
          sudo cp -r asam-antora-extensions/node_modules/* /usr/src/app/node_modules/

      # ───────────────────────────────────────────────────────────────
      # 4) Run Antora
      # ───────────────────────────────────────────────────────────────
      - name: Build docs with Antora
        run: npx antora antora-playbook.yml

      # ───────────────────────────────────────────────────────────────
      # 5) Zip and upload the generated site
      # ───────────────────────────────────────────────────────────────
      - name: Zip site
        working-directory: ${{ env.site_path }}
        run: zip -r ${{ env.site_zip }} .

      - uses: actions/upload-artifact@v4
        with:
          name: openDAQ_SDK_User_Guide
          path: ${{ env.site_zip }}
          retention-days: 7
