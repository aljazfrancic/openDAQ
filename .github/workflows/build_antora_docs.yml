name: Build openDAQ SDK documentation
on: workflow_dispatch

env:
  site_path: ${{ github.workspace }}/build/site/
  site_zip:  ${{ github.workspace }}/build/user_guide.zip

jobs:
  build_documentation:
    runs-on: ubuntu-22.04
    timeout-minutes: 7

    steps:
      # ──────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ──────────────────────────────────────────────────────────────
      # 1.  Node & global JS deps (Antora + UI/tab extensions)
      # ──────────────────────────────────────────────────────────────
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install top-level JS dependencies
        run: |
          npm install antora                       \
                      @asciidoctor/tabs            \
                      @springio/antora-extensions

      # ──────────────────────────────────────────────────────────────
      # 2.  Clone the ASAM Antora Doxygen extension
      # ──────────────────────────────────────────────────────────────
      - name: Clone ASAM Antora extension
        run: git clone https://code.asam.net/common/asam-antora-extensions.git asam-antora-extensions

      # ──────────────────────────────────────────────────────────────
      # 3.  Install the extension’s own dependencies (vinyl, jsdom…)
      #     right inside its folder
      # ──────────────────────────────────────────────────────────────
      - name: Install extension-local dependencies
        run: |
          cd asam-antora-extensions
          npm install        # reads the extension’s package.json
          cd ..

      # ──────────────────────────────────────────────────────────────
      # 4.  Build docs.  NODE_PATH tells Node/Antora to also look in
      #     both node_modules trees when resolving requires.
      # ──────────────────────────────────────────────────────────────
      - name: Run Antora
        env:
          NODE_PATH: ${{ github.workspace }}/node_modules:${{ github.workspace }}/asam-antora-extensions/node_modules
        run: npx antora antora-playbook.yml

      # ──────────────────────────────────────────────────────────────
      # 5.  Zip and upload the generated site
      # ──────────────────────────────────────────────────────────────
      - name: Zip site
        working-directory: ${{ env.site_path }}
        run: zip -r ${{ env.site_zip }} .

      - uses: actions/upload-artifact@v4
        with:
          name: openDAQ_SDK_User_Guide
          path: ${{ env.site_zip }}
          retention-days: 7
